<?php
// student_attendance_system/index.php
// Summary: Basic attendance system using QR code and PHP (Problem #1 Implementation)

// Create/open SQLite DB
$db = new SQLite3('attendance.db');
$db->exec("CREATE TABLE IF NOT EXISTS students (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT,
    reg_no TEXT UNIQUE
)");
$db->exec("CREATE TABLE IF NOT EXISTS attendance (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    reg_no TEXT,
    date TEXT,
    time TEXT
)");

// Handle registration (for simplicity, manually adding student)
if (isset($_POST['name']) && isset($_POST['reg_no'])) {
    $stmt = $db->prepare("INSERT OR IGNORE INTO students (name, reg_no) VALUES (?, ?)");
    $stmt->bindValue(1, $_POST['name']);
    $stmt->bindValue(2, $_POST['reg_no']);
    $stmt->execute();
}

// Handle QR scan (simulate by form input of reg_no)
if (isset($_POST['scan_reg_no'])) {
    $date = date("Y-m-d");
    $time = date("H:i:s");
    $stmt = $db->prepare("INSERT INTO attendance (reg_no, date, time) VALUES (?, ?, ?)");
    $stmt->bindValue(1, $_POST['scan_reg_no']);
    $stmt->bindValue(2, $date);
    $stmt->bindValue(3, $time);
    $stmt->execute();
}

$results = $db->query("SELECT * FROM attendance ORDER BY id DESC");
?>
<!DOCTYPE html>
<html>
<head>
    <title>Student Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-4">
<h2>Student Registration</h2>
<form method="POST" class="mb-4">
    <input class="form-control mb-2" type="text" name="name" placeholder="Full Name" required>
    <input class="form-control mb-2" type="text" name="reg_no" placeholder="Registration Number" required>
    <button class="btn btn-primary" type="submit">Register Student</button>
</form>

<h2>Scan Attendance (Simulated)</h2>
<form method="POST" class="mb-4">
    <input class="form-control mb-2" type="text" name="scan_reg_no" placeholder="Enter Reg Number (from QR)" required>
    <button class="btn btn-success" type="submit">Mark Attendance</button>
</form>

<h3>Attendance Records</h3>
<table class="table table-bordered">
    <thead><tr><th>#</th><th>Reg No</th><th>Date</th><th>Time</th></tr></thead>
    <tbody>
    <?php $i = 1; while ($row = $results->fetchArray()) { ?>
        <tr>
            <td><?= $i++ ?></td>
            <td><?= htmlspecialchars($row['reg_no']) ?></td>
            <td><?= $row['date'] ?></td>
            <td><?= $row['time'] ?></td>
        </tr>
    <?php } ?>
    </tbody>
</table>
</body>
</html>
